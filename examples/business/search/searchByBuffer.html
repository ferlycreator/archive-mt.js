<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style type="text/css">
        html,body{ margin:0px; height:100%; };
    </style>
    <title>MapTalks 示例: 缓冲查询</title>
</head>
<body scroll="no" onload="initMap();">
<div id="mapObj" style="width:100%;height:100%;float:right;margin-top:0px"></div>
<script type="text/javascript" >
    var mapObj,featureQuery,topoQuery,layer,drawTool;
    function initMap(){
        //创建地图对象
        mapObj = new maptalks.Map('mapObj', //放置mapObj的div id
        {
            center:  new maptalks.Coordinate(121.489935,31.24432), //初始中心点坐标
            zoomLevel:   11 //初始缩放级别
        });
        //设置底图图层
        mapObj.setBaseTileLayer(new maptalks.TileLayer('tile', //底图id
        {
            /*tileInfo: 'web-mercator',
            urlTemplate:'http://emap{s}.mapabc.com/mapabc/maptile?&x={x}&y={y}&z={z}',//底图服务url
            subdomains:[1,2,3]//地图服务url子域名变量,对应urlTemplate中占位符{s}的值*/
            tileInfo : 'baidu',
            urlTemplate:'http://online{s}.map.bdimg.com/tile/?qt=tile&x={x}&y={y}&z={z}&styles=pl',
            /**
            *urlTemplate中占位符{s}所有数值的数组
            */
            subdomains:[0,1,2,3,4,5,6,7,8,9]
        }));
        //创建图层
        layer = new maptalks.VectorLayer('layer',{render:'canvas'});
        //将图层添加到地图对象
        mapObj.addLayer(layer);
        //构造绘图工具
        //构造绘制面工具
        drawTool = new maptalks.DrawTool({
            /**
            *设置drawTool绘制的图形类型
            *TYPE_POLYGON： 多边形；TYPE_RECT：矩形；TYPE_ELLIPSE：圆形
            */
            mode: maptalks.Geometry.TYPE_POLYGON,
            //绘制面的样式
            symbol: {
                'lineColor':'#000000',
                'lineWidth':1,
                'lineOpacity':0.8,
                'lineDasharray': [],
                'polygonFill': '#ffffff',
                'polygonOpacity': 0.6
            }
        });
        //将线绘制工具绑定到地图对象
        drawTool.addTo(mapObj);
        //监听绘制工具完成事件
        drawTool.on('drawend', onAfterDraw);
        drawTool.disable();
        //拓扑运算对象
        topoQuery = new maptalks.TopoQuery({host:'localhost',port:8090});
        //构造查询对象
        featureQuery = new maptalks.FeatureQuery({
            'host': 'localhost',//空间数据库地址
            'port': 8090,//端口
            'mapdb': 'mapdata'//空间库名
        });
        //年份工具条
        var toolbar = new maptalks.Toolbar({
            id: 'toolbar',//toolbar id
            position : { //工具条放置位置
                top: '2',
                left: '2'
            },
            vertical : false,
            //工具项
            items: [{
                type : 'button',
                content: '标注缓冲点',
                click : function(){
                    drawTool.setMode(maptalks.Geometry.TYPE_POINT);
                    drawTool.enable();
                }
            }, {
                type : 'button',
                content: '绘制缓冲线',
                click : function(){
                    drawTool.setMode(maptalks.Geometry.TYPE_LINESTRING);
                    drawTool.enable();
                }
            }, {
                type : 'button',
                content: '绘制面',
                click : function(){
                    drawTool.setMode(maptalks.Geometry.TYPE_POLYGON);
                    drawTool.enable();
                }
            }]
        });
        mapObj.addControl(toolbar);
    }

    function onAfterDraw(param) {
        drawTool.disable();
        //绘制的图形
        var geometry = param.geometry;
        var coordinate = geometry.getCoordinates();
        var geometryType = geometry.getType();
        var filterGeometry;
        if(geometryType===maptalks.Geometry.TYPE_POLYGON){
            searchData(geometry);
        } else {

        var hitBufferSymbol = {
            'lineColor' : '#ab2d00',
            'lineWidth' : 3,
            'lineOpacity' : 1,
            'lineDasharray' :[],
            'polygonFill': '#ff000d',
            'polygonOpacity': 0.2
        };
        //绘制目标监控缓冲区
        topoQuery.buffer({
            geometries:[geometry],
            distance:1000,
            success: function(geometries){
                for(var i=0,len=geometries.length;i<len;i++) {
                    var geo = geometries[i];
                    geo.setSymbol(hitBufferSymbol);
                    searchData(geo);
                }
            }
        });
        }

    };

    function searchData(geometry) {
        layer.addGeometry(geometry);
        var spatialFilter = {
            'geometry' : geometry.toJson(), //空间参考图形
            'relation' : maptalks.SpatialFilter.RELATION_CONTAIN //与空间参考图形的关系
        };
        featureQuery.query({
            'layer': 'MALL_SH',
            'queryFilter': {
                'returnGeometry': true,
                'resultCrs':'gcj02',
                'spatialFilter': JSON.stringify(spatialFilter)
            },
            /**
             * 设置空间查询条件
             */
            'success': function(geos) {
                //将返回的图形添加到图层上
                var geometries = geos[0].features;
                console.log(geometries);
                layer.addGeometry(geometries);
            },
            'error': function(error) {
                console.error(error);
            }
        });
    }
</script>
<!-- 引擎javascript开发包-->
<script type="text/javascript" src="../../../maptalks.min.js"></script>
<!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
<!--[if lt IE 9]>
  <script src="http://cdn.bootcss.com/html5shiv/3.7.0/html5shiv.min.js"></script>
<![endif]-->
</body>
</html>
